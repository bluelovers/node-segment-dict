"use strict";
/**
 * Created by user on 2018/4/13/013.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const stream = require("stream");
const fs = require("fs");
const path = require("path");
const line_1 = require("./line");
function createLoadStreamSync(file, options = {}) {
    options.onready = options.onready || function (src, ...argv) {
        this.value = this.value || [];
    };
    options.mapper = options.mapper || function (data) {
        return data;
    };
    options.ondata = options.ondata || function (data) {
        this.value = this.value || [];
        this.value.push(data);
    };
    let stream = createStreamLineSync(file, options.mapper, {
        onready: options.onready,
        ondata: options.ondata,
        onclose() {
            if (options.callback) {
                options.callback.call(this, null, stream.value, stream);
            }
        }
    });
    // @ts-ignore
    stream.pipeFrom.run();
    return stream;
}
exports.createLoadStreamSync = createLoadStreamSync;
function createStreamLineSync(file, fn, options) {
    return createReadStreamSync(file)
        .pipe(line_1.byLine(fn, options));
}
exports.createStreamLineSync = createStreamLineSync;
function createReadStreamSync(file) {
    return new ReadableSync(file);
}
exports.createReadStreamSync = createReadStreamSync;
class ReadableSync extends stream.Readable {
    constructor(file) {
        super();
        this.fd = null;
        this.flags = 'r';
        this.bytesRead = 0;
        this.options = {
            readChunk: 1024,
        };
        this.path = file;
        if (typeof file === 'number') {
            this.fd = file;
        }
        else {
            if (typeof file == 'string') {
                this.path = path.resolve(file);
            }
            this.fd = fs.openSync(this.path, this.flags);
        }
        this.pause();
    }
    _read(size) {
        let buffers = [];
        let bytesRead;
        do {
            bytesRead = this.__read(size);
            if (bytesRead !== null) {
                buffers.push(bytesRead);
            }
        } while (bytesRead !== null);
        let bufferData = Buffer.concat(buffers);
        this.push(bufferData);
        //this._destroy(null, () => undefined);
        return bufferData;
    }
    __read(size) {
        //let readBuffer = new Buffer(this.options.readChunk);
        let readBuffer = Buffer.alloc(this.options.readChunk);
        let bytesRead = fs.readSync(this.fd, readBuffer, 0, this.options.readChunk, this.bytesRead);
        if (bytesRead === 0) {
            this.fdEnd = true;
            return null;
        }
        this.bytesRead += bytesRead;
        if (bytesRead < this.options.readChunk) {
            this.fdEnd = true;
            readBuffer = readBuffer.slice(0, bytesRead);
        }
        return readBuffer;
    }
    run() {
        this.resume();
        this.emit('ready', this);
        let i = 0;
        while (!this.fdEnd) {
            let k = this.read();
        }
        //let bufferData = this.__read(this.options.readChunk);
        //this.emit('data', bufferData);
        return this;
    }
}
exports.ReadableSync = ReadableSync;
exports.default = createLoadStreamSync;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3luYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN5bmMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILGlDQUFrQztBQUNsQyx5QkFBMEI7QUFDMUIsNkJBQThCO0FBRTlCLGlDQUE2RTtBQUc3RSxTQUFnQixvQkFBb0IsQ0FBSSxJQUFZLEVBQUUsVUFTbEQsRUFBRTtJQUVMLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxVQUFVLEdBQUcsRUFBRSxHQUFHLElBQUk7UUFFMUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDLENBQUM7SUFFRixPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksVUFBVSxJQUFJO1FBRWhELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQyxDQUFDO0lBRUYsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLFVBQVUsSUFBSTtRQUVoRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZCLENBQUMsQ0FBQztJQUVGLElBQUksTUFBTSxHQUE4QixvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUVsRixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU87UUFFeEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNO1FBQ3RCLE9BQU87WUFFTixJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQ3BCO2dCQUNDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQTthQUN2RDtRQUNGLENBQUM7S0FDRCxDQUFDLENBQUM7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QUFDO1NBQzVDO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDbkIsQ0FBQztJQUVELEdBQUc7UUFFRixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFZCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUV6QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFVixPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFDbEI7WUFDQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDcEI7UUFFRCx1REFBdUQ7UUFDdkQsZ0NBQWdDO1FBRWhDLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztDQUNEO0FBckdELG9DQXFHQztBQUVELGtCQUFlLG9CQUFvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC80LzEzLzAxMy5cbiAqL1xuXG5pbXBvcnQgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5pbXBvcnQgRXZlbnRFbWl0dGVyID0gcmVxdWlyZSgnZXZlbnRzJyk7XG5pbXBvcnQgeyBieUxpbmUsIElPcHRpb25zLCBJU3RyZWFtTGluZSwgSVN0cmVhbUxpbmVXaXRoVmFsdWUgfSBmcm9tICcuL2xpbmUnO1xuaW1wb3J0IHsgSUNhbGxiYWNrIH0gZnJvbSAnLi9zdHJlYW0nO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTG9hZFN0cmVhbVN5bmM8VD4oZmlsZTogc3RyaW5nLCBvcHRpb25zOiB7XG5cblx0bWFwcGVyPyhsaW5lOiBzdHJpbmcpLFxuXHRvbmRhdGE/KGRhdGEpLFxuXG5cdGNhbGxiYWNrPzogSUNhbGxiYWNrPFQ+LFxuXG5cdG9ucmVhZHk/KC4uLmFyZ3YpLFxuXG59ID0ge30pOiBJU3RyZWFtTGluZVdpdGhWYWx1ZTxUPlxue1xuXHRvcHRpb25zLm9ucmVhZHkgPSBvcHRpb25zLm9ucmVhZHkgfHwgZnVuY3Rpb24gKHNyYywgLi4uYXJndilcblx0e1xuXHRcdHRoaXMudmFsdWUgPSB0aGlzLnZhbHVlIHx8IFtdO1xuXHR9O1xuXG5cdG9wdGlvbnMubWFwcGVyID0gb3B0aW9ucy5tYXBwZXIgfHwgZnVuY3Rpb24gKGRhdGEpXG5cdHtcblx0XHRyZXR1cm4gZGF0YTtcblx0fTtcblxuXHRvcHRpb25zLm9uZGF0YSA9IG9wdGlvbnMub25kYXRhIHx8IGZ1bmN0aW9uIChkYXRhKVxuXHR7XG5cdFx0dGhpcy52YWx1ZSA9IHRoaXMudmFsdWUgfHwgW107XG5cdFx0dGhpcy52YWx1ZS5wdXNoKGRhdGEpO1xuXHR9O1xuXG5cdGxldCBzdHJlYW06IElTdHJlYW1MaW5lV2l0aFZhbHVlPGFueT4gPSBjcmVhdGVTdHJlYW1MaW5lU3luYyhmaWxlLCBvcHRpb25zLm1hcHBlciwge1xuXG5cdFx0b25yZWFkeTogb3B0aW9ucy5vbnJlYWR5LFxuXG5cdFx0b25kYXRhOiBvcHRpb25zLm9uZGF0YSxcblx0XHRvbmNsb3NlKClcblx0XHR7XG5cdFx0XHRpZiAob3B0aW9ucy5jYWxsYmFjaylcblx0XHRcdHtcblx0XHRcdFx0b3B0aW9ucy5jYWxsYmFjay5jYWxsKHRoaXMsIG51bGwsIHN0cmVhbS52YWx1ZSwgc3RyZWFtKVxuXHRcdFx0fVxuXHRcdH1cblx0fSk7XG5cblx0Ly8gQHRzLWlnbm9yZVxuXHRzdHJlYW0ucGlwZUZyb20ucnVuKCk7XG5cblx0cmV0dXJuIHN0cmVhbTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVN0cmVhbUxpbmVTeW5jKGZpbGU6IHN0cmluZywgb3B0aW9uczogSU9wdGlvbnMpOiBJU3RyZWFtTGluZVxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVN0cmVhbUxpbmVTeW5jKGZpbGU6IHN0cmluZywgZm4/OiAoZGF0YTogc3RyaW5nKSA9PiBhbnksIG9wdGlvbnM/OiBJT3B0aW9ucyk6IElTdHJlYW1MaW5lXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3RyZWFtTGluZVN5bmMoZmlsZTogc3RyaW5nLCBmbj8sIG9wdGlvbnM/OiBJT3B0aW9ucylcbntcblx0cmV0dXJuIGNyZWF0ZVJlYWRTdHJlYW1TeW5jKGZpbGUpXG5cdFx0LnBpcGUoYnlMaW5lKGZuLCBvcHRpb25zKSlcblx0XHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVSZWFkU3RyZWFtU3luYyhmaWxlOiBzdHJpbmcpXG57XG5cdHJldHVybiBuZXcgUmVhZGFibGVTeW5jKGZpbGUpO1xufVxuXG5leHBvcnQgY2xhc3MgUmVhZGFibGVTeW5jIGV4dGVuZHMgc3RyZWFtLlJlYWRhYmxlXG57XG5cdHByb3RlY3RlZCBmZDogbnVtYmVyID0gbnVsbDtcblx0cHJvdGVjdGVkIGZsYWdzOiBzdHJpbmcgfCBudW1iZXIgPSAncic7XG5cdHB1YmxpYyBieXRlc1JlYWQ6IG51bWJlciA9IDA7XG5cdHB1YmxpYyBwYXRoOiBzdHJpbmc7XG5cblx0cHJvdGVjdGVkIGZkRW5kOiBib29sZWFuO1xuXG5cdHByb3RlY3RlZCBvcHRpb25zID0ge1xuXHRcdHJlYWRDaHVuazogMTAyNCxcblx0fTtcblxuXHRjb25zdHJ1Y3RvcihmaWxlOiBzdHJpbmcpXG5cdHtcblx0XHRzdXBlcigpO1xuXG5cdFx0dGhpcy5wYXRoID0gZmlsZTtcblxuXHRcdGlmICh0eXBlb2YgZmlsZSA9PT0gJ251bWJlcicpXG5cdFx0e1xuXHRcdFx0dGhpcy5mZCA9IGZpbGU7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRpZiAodHlwZW9mIGZpbGUgPT0gJ3N0cmluZycpXG5cdFx0XHR7XG5cdFx0XHRcdHRoaXMucGF0aCA9IHBhdGgucmVzb2x2ZShmaWxlKTtcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5mZCA9IGZzLm9wZW5TeW5jKHRoaXMucGF0aCwgdGhpcy5mbGFncyk7XG5cdFx0fVxuXG5cdFx0dGhpcy5wYXVzZSgpO1xuXHR9XG5cblx0X3JlYWQoc2l6ZTogbnVtYmVyKTogQnVmZmVyXG5cdHtcblx0XHRsZXQgYnVmZmVyczogQnVmZmVyW10gPSBbXTtcblx0XHRsZXQgYnl0ZXNSZWFkOiBCdWZmZXI7XG5cblx0XHRkb1xuXHRcdHtcblx0XHRcdGJ5dGVzUmVhZCA9IHRoaXMuX19yZWFkKHNpemUpO1xuXG5cdFx0XHRpZiAoYnl0ZXNSZWFkICE9PSBudWxsKVxuXHRcdFx0e1xuXHRcdFx0XHRidWZmZXJzLnB1c2goYnl0ZXNSZWFkKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0d2hpbGUgKGJ5dGVzUmVhZCAhPT0gbnVsbCk7XG5cblx0XHRsZXQgYnVmZmVyRGF0YSA9IEJ1ZmZlci5jb25jYXQoYnVmZmVycyk7XG5cblx0XHR0aGlzLnB1c2goYnVmZmVyRGF0YSk7XG5cdFx0Ly90aGlzLl9kZXN0cm95KG51bGwsICgpID0+IHVuZGVmaW5lZCk7XG5cblx0XHRyZXR1cm4gYnVmZmVyRGF0YTtcblx0fVxuXG5cdF9fcmVhZChzaXplOiBudW1iZXIpOiBCdWZmZXJcblx0e1xuXHRcdC8vbGV0IHJlYWRCdWZmZXIgPSBuZXcgQnVmZmVyKHRoaXMub3B0aW9ucy5yZWFkQ2h1bmspO1xuXHRcdGxldCByZWFkQnVmZmVyID0gQnVmZmVyLmFsbG9jKHRoaXMub3B0aW9ucy5yZWFkQ2h1bmspO1xuXG5cdFx0bGV0IGJ5dGVzUmVhZCA9IGZzLnJlYWRTeW5jKHRoaXMuZmQsIHJlYWRCdWZmZXIsIDAsIHRoaXMub3B0aW9ucy5yZWFkQ2h1bmssIHRoaXMuYnl0ZXNSZWFkKTtcblxuXHRcdGlmIChieXRlc1JlYWQgPT09IDApXG5cdFx0e1xuXHRcdFx0dGhpcy5mZEVuZCA9IHRydWU7XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cblx0XHR0aGlzLmJ5dGVzUmVhZCArPSBieXRlc1JlYWQ7XG5cblx0XHRpZiAoYnl0ZXNSZWFkIDwgdGhpcy5vcHRpb25zLnJlYWRDaHVuaykge1xuXHRcdFx0dGhpcy5mZEVuZCA9IHRydWU7XG5cdFx0XHRyZWFkQnVmZmVyID0gcmVhZEJ1ZmZlci5zbGljZSgwLCBieXRlc1JlYWQpO1xuXHRcdH1cblxuXHRcdHJldHVybiByZWFkQnVmZmVyO1xuXHR9XG5cblx0cnVuKClcblx0e1xuXHRcdHRoaXMucmVzdW1lKCk7XG5cblx0XHR0aGlzLmVtaXQoJ3JlYWR5JywgdGhpcyk7XG5cblx0XHRsZXQgaSA9IDA7XG5cblx0XHR3aGlsZSAoIXRoaXMuZmRFbmQpXG5cdFx0e1xuXHRcdFx0bGV0IGsgPSB0aGlzLnJlYWQoKTtcblx0XHR9XG5cblx0XHQvL2xldCBidWZmZXJEYXRhID0gdGhpcy5fX3JlYWQodGhpcy5vcHRpb25zLnJlYWRDaHVuayk7XG5cdFx0Ly90aGlzLmVtaXQoJ2RhdGEnLCBidWZmZXJEYXRhKTtcblxuXHRcdHJldHVybiB0aGlzO1xuXHR9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNyZWF0ZUxvYWRTdHJlYW1TeW5jO1xuIl19