"use strict";
/**
 * Created by user on 2018/4/13/013.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const stream = require("stream");
const fs = require("fs");
const path = require("path");
const line_1 = require("./line");
function createLoadStreamSync(file, options = {}) {
    options.onready = options.onready || function (src, ...argv) {
        this.value = this.value || [];
    };
    options.mapper = options.mapper || function (data) {
        return data;
    };
    options.ondata = options.ondata || function (data) {
        this.value = this.value || [];
        this.value.push(data);
    };
    let stream = createStreamLineSync(file, options.mapper, {
        onready: options.onready,
        ondata: options.ondata,
        onclose() {
            if (options.callback) {
                options.callback.call(this, null, stream.value, stream);
            }
        }
    });
    // @ts-ignore
    stream.pipeFrom.run();
    return stream;
}
exports.createLoadStreamSync = createLoadStreamSync;
function createStreamLineSync(file, fn, options) {
    return createReadStreamSync(file)
        .pipe(line_1.byLine(fn, options));
}
exports.createStreamLineSync = createStreamLineSync;
function createReadStreamSync(file) {
    return new ReadableSync(file);
}
exports.createReadStreamSync = createReadStreamSync;
class ReadableSync extends stream.Readable {
    constructor(file) {
        super();
        this.fd = null;
        this.flags = 'r';
        this.bytesRead = 0;
        this.options = {
            readChunk: 1024,
        };
        this.path = file;
        if (typeof file === 'number') {
            this.fd = file;
        }
        else {
            if (typeof file == 'string') {
                this.path = path.resolve(file);
            }
            this.fd = fs.openSync(this.path, this.flags);
        }
        this.pause();
    }
    _read(size) {
        let buffers = [];
        let bytesRead;
        do {
            bytesRead = this.__read(size);
            if (bytesRead !== null) {
                buffers.push(bytesRead);
            }
        } while (bytesRead !== null);
        let bufferData = Buffer.concat(buffers);
        this.push(bufferData);
        //this._destroy(null, () => undefined);
        return bufferData;
    }
    __read(size) {
        //let readBuffer = new Buffer(this.options.readChunk);
        let readBuffer = Buffer.alloc(this.options.readChunk);
        let bytesRead = fs.readSync(this.fd, readBuffer, 0, this.options.readChunk, this.bytesRead);
        if (bytesRead === 0) {
            this.fdEnd = true;
            return null;
        }
        this.bytesRead += bytesRead;
        if (bytesRead < this.options.readChunk) {
            this.fdEnd = true;
            readBuffer = readBuffer.slice(0, bytesRead);
        }
        return readBuffer;
    }
    run() {
        this.resume();
        this.emit('ready', this);
        let i = 0;
        while (!this.fdEnd) {
            let k = this.read();
        }
        //let bufferData = this.__read(this.options.readChunk);
        //this.emit('data', bufferData);
        return this;
    }
}
exports.ReadableSync = ReadableSync;
exports.default = createLoadStreamSync;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3luYy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInN5bmMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILGlDQUFpQztBQUNqQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBRTdCLGlDQUE2RTtBQUc3RSxTQUFnQixvQkFBb0IsQ0FBSSxJQUFZLEVBQUUsVUFTbEQsRUFBRTtJQUVMLE9BQU8sQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxVQUFVLEdBQUcsRUFBRSxHQUFHLElBQUk7UUFFMUQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDLENBQUM7SUFFRixPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLElBQUksVUFBVSxJQUFJO1FBRWhELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQyxDQUFDO0lBRUYsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxJQUFJLFVBQVUsSUFBSTtRQUVoRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDO1FBQzlCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3ZCLENBQUMsQ0FBQztJQUVGLElBQUksTUFBTSxHQUE4QixvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLE1BQU0sRUFBRTtRQUVsRixPQUFPLEVBQUUsT0FBTyxDQUFDLE9BQU87UUFFeEIsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNO1FBQ3RCLE9BQU87WUFFTixJQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQ3BCO2dCQUNDLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQTthQUN2RDtRQUNGLENBQUM7S0FDRCxDQUFDLENBQUM7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QUFDO1NBQzVDO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDbkIsQ0FBQztJQUVELEdBQUc7UUFFRixJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFZCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUV6QixJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFVixPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFDbEI7WUFDQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDcEI7UUFFRCx1REFBdUQ7UUFDdkQsZ0NBQWdDO1FBRWhDLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztDQUNEO0FBckdELG9DQXFHQztBQUVELGtCQUFlLG9CQUFvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC80LzEzLzAxMy5cbiAqL1xuXG5pbXBvcnQgKiBhcyBzdHJlYW0gZnJvbSAnc3RyZWFtJztcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBFdmVudEVtaXR0ZXIgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGJ5TGluZSwgSU9wdGlvbnMsIElTdHJlYW1MaW5lLCBJU3RyZWFtTGluZVdpdGhWYWx1ZSB9IGZyb20gJy4vbGluZSc7XG5pbXBvcnQgeyBJQ2FsbGJhY2sgfSBmcm9tICcuL3N0cmVhbSc7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVMb2FkU3RyZWFtU3luYzxUPihmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IHtcblxuXHRtYXBwZXI/KGxpbmU6IHN0cmluZyksXG5cdG9uZGF0YT8oZGF0YSksXG5cblx0Y2FsbGJhY2s/OiBJQ2FsbGJhY2s8VD4sXG5cblx0b25yZWFkeT8oLi4uYXJndiksXG5cbn0gPSB7fSk6IElTdHJlYW1MaW5lV2l0aFZhbHVlPFQ+XG57XG5cdG9wdGlvbnMub25yZWFkeSA9IG9wdGlvbnMub25yZWFkeSB8fCBmdW5jdGlvbiAoc3JjLCAuLi5hcmd2KVxuXHR7XG5cdFx0dGhpcy52YWx1ZSA9IHRoaXMudmFsdWUgfHwgW107XG5cdH07XG5cblx0b3B0aW9ucy5tYXBwZXIgPSBvcHRpb25zLm1hcHBlciB8fCBmdW5jdGlvbiAoZGF0YSlcblx0e1xuXHRcdHJldHVybiBkYXRhO1xuXHR9O1xuXG5cdG9wdGlvbnMub25kYXRhID0gb3B0aW9ucy5vbmRhdGEgfHwgZnVuY3Rpb24gKGRhdGEpXG5cdHtcblx0XHR0aGlzLnZhbHVlID0gdGhpcy52YWx1ZSB8fCBbXTtcblx0XHR0aGlzLnZhbHVlLnB1c2goZGF0YSk7XG5cdH07XG5cblx0bGV0IHN0cmVhbTogSVN0cmVhbUxpbmVXaXRoVmFsdWU8YW55PiA9IGNyZWF0ZVN0cmVhbUxpbmVTeW5jKGZpbGUsIG9wdGlvbnMubWFwcGVyLCB7XG5cblx0XHRvbnJlYWR5OiBvcHRpb25zLm9ucmVhZHksXG5cblx0XHRvbmRhdGE6IG9wdGlvbnMub25kYXRhLFxuXHRcdG9uY2xvc2UoKVxuXHRcdHtcblx0XHRcdGlmIChvcHRpb25zLmNhbGxiYWNrKVxuXHRcdFx0e1xuXHRcdFx0XHRvcHRpb25zLmNhbGxiYWNrLmNhbGwodGhpcywgbnVsbCwgc3RyZWFtLnZhbHVlLCBzdHJlYW0pXG5cdFx0XHR9XG5cdFx0fVxuXHR9KTtcblxuXHQvLyBAdHMtaWdub3JlXG5cdHN0cmVhbS5waXBlRnJvbS5ydW4oKTtcblxuXHRyZXR1cm4gc3RyZWFtO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3RyZWFtTGluZVN5bmMoZmlsZTogc3RyaW5nLCBvcHRpb25zOiBJT3B0aW9ucyk6IElTdHJlYW1MaW5lXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3RyZWFtTGluZVN5bmMoZmlsZTogc3RyaW5nLCBmbj86IChkYXRhOiBzdHJpbmcpID0+IGFueSwgb3B0aW9ucz86IElPcHRpb25zKTogSVN0cmVhbUxpbmVcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVTdHJlYW1MaW5lU3luYyhmaWxlOiBzdHJpbmcsIGZuPywgb3B0aW9ucz86IElPcHRpb25zKVxue1xuXHRyZXR1cm4gY3JlYXRlUmVhZFN0cmVhbVN5bmMoZmlsZSlcblx0XHQucGlwZShieUxpbmUoZm4sIG9wdGlvbnMpKVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlYWRTdHJlYW1TeW5jKGZpbGU6IHN0cmluZylcbntcblx0cmV0dXJuIG5ldyBSZWFkYWJsZVN5bmMoZmlsZSk7XG59XG5cbmV4cG9ydCBjbGFzcyBSZWFkYWJsZVN5bmMgZXh0ZW5kcyBzdHJlYW0uUmVhZGFibGVcbntcblx0cHJvdGVjdGVkIGZkOiBudW1iZXIgPSBudWxsO1xuXHRwcm90ZWN0ZWQgZmxhZ3M6IHN0cmluZyB8IG51bWJlciA9ICdyJztcblx0cHVibGljIGJ5dGVzUmVhZDogbnVtYmVyID0gMDtcblx0cHVibGljIHBhdGg6IHN0cmluZztcblxuXHRwcm90ZWN0ZWQgZmRFbmQ6IGJvb2xlYW47XG5cblx0cHJvdGVjdGVkIG9wdGlvbnMgPSB7XG5cdFx0cmVhZENodW5rOiAxMDI0LFxuXHR9O1xuXG5cdGNvbnN0cnVjdG9yKGZpbGU6IHN0cmluZylcblx0e1xuXHRcdHN1cGVyKCk7XG5cblx0XHR0aGlzLnBhdGggPSBmaWxlO1xuXG5cdFx0aWYgKHR5cGVvZiBmaWxlID09PSAnbnVtYmVyJylcblx0XHR7XG5cdFx0XHR0aGlzLmZkID0gZmlsZTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdGlmICh0eXBlb2YgZmlsZSA9PSAnc3RyaW5nJylcblx0XHRcdHtcblx0XHRcdFx0dGhpcy5wYXRoID0gcGF0aC5yZXNvbHZlKGZpbGUpO1xuXHRcdFx0fVxuXG5cdFx0XHR0aGlzLmZkID0gZnMub3BlblN5bmModGhpcy5wYXRoLCB0aGlzLmZsYWdzKTtcblx0XHR9XG5cblx0XHR0aGlzLnBhdXNlKCk7XG5cdH1cblxuXHRfcmVhZChzaXplOiBudW1iZXIpOiBCdWZmZXJcblx0e1xuXHRcdGxldCBidWZmZXJzOiBCdWZmZXJbXSA9IFtdO1xuXHRcdGxldCBieXRlc1JlYWQ6IEJ1ZmZlcjtcblxuXHRcdGRvXG5cdFx0e1xuXHRcdFx0Ynl0ZXNSZWFkID0gdGhpcy5fX3JlYWQoc2l6ZSk7XG5cblx0XHRcdGlmIChieXRlc1JlYWQgIT09IG51bGwpXG5cdFx0XHR7XG5cdFx0XHRcdGJ1ZmZlcnMucHVzaChieXRlc1JlYWQpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHR3aGlsZSAoYnl0ZXNSZWFkICE9PSBudWxsKTtcblxuXHRcdGxldCBidWZmZXJEYXRhID0gQnVmZmVyLmNvbmNhdChidWZmZXJzKTtcblxuXHRcdHRoaXMucHVzaChidWZmZXJEYXRhKTtcblx0XHQvL3RoaXMuX2Rlc3Ryb3kobnVsbCwgKCkgPT4gdW5kZWZpbmVkKTtcblxuXHRcdHJldHVybiBidWZmZXJEYXRhO1xuXHR9XG5cblx0X19yZWFkKHNpemU6IG51bWJlcik6IEJ1ZmZlclxuXHR7XG5cdFx0Ly9sZXQgcmVhZEJ1ZmZlciA9IG5ldyBCdWZmZXIodGhpcy5vcHRpb25zLnJlYWRDaHVuayk7XG5cdFx0bGV0IHJlYWRCdWZmZXIgPSBCdWZmZXIuYWxsb2ModGhpcy5vcHRpb25zLnJlYWRDaHVuayk7XG5cblx0XHRsZXQgYnl0ZXNSZWFkID0gZnMucmVhZFN5bmModGhpcy5mZCwgcmVhZEJ1ZmZlciwgMCwgdGhpcy5vcHRpb25zLnJlYWRDaHVuaywgdGhpcy5ieXRlc1JlYWQpO1xuXG5cdFx0aWYgKGJ5dGVzUmVhZCA9PT0gMClcblx0XHR7XG5cdFx0XHR0aGlzLmZkRW5kID0gdHJ1ZTtcblx0XHRcdHJldHVybiBudWxsO1xuXHRcdH1cblxuXHRcdHRoaXMuYnl0ZXNSZWFkICs9IGJ5dGVzUmVhZDtcblxuXHRcdGlmIChieXRlc1JlYWQgPCB0aGlzLm9wdGlvbnMucmVhZENodW5rKSB7XG5cdFx0XHR0aGlzLmZkRW5kID0gdHJ1ZTtcblx0XHRcdHJlYWRCdWZmZXIgPSByZWFkQnVmZmVyLnNsaWNlKDAsIGJ5dGVzUmVhZCk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHJlYWRCdWZmZXI7XG5cdH1cblxuXHRydW4oKVxuXHR7XG5cdFx0dGhpcy5yZXN1bWUoKTtcblxuXHRcdHRoaXMuZW1pdCgncmVhZHknLCB0aGlzKTtcblxuXHRcdGxldCBpID0gMDtcblxuXHRcdHdoaWxlICghdGhpcy5mZEVuZClcblx0XHR7XG5cdFx0XHRsZXQgayA9IHRoaXMucmVhZCgpO1xuXHRcdH1cblxuXHRcdC8vbGV0IGJ1ZmZlckRhdGEgPSB0aGlzLl9fcmVhZCh0aGlzLm9wdGlvbnMucmVhZENodW5rKTtcblx0XHQvL3RoaXMuZW1pdCgnZGF0YScsIGJ1ZmZlckRhdGEpO1xuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgY3JlYXRlTG9hZFN0cmVhbVN5bmM7XG4iXX0=