"use strict";
/**
 * Created by user on 2018/4/11/011.
 */
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const split2 = require("split2");
const path = require("path");
const Promise = require("bluebird");
const stream_pipe_1 = require("stream-pipe");
function byLine(fn, options = {}) {
    if (typeof fn == 'object') {
        [options, fn] = [fn, undefined];
    }
    fn = fn || options.mapper;
    let wts = split2(fn);
    wts.on('pipe', function (src) {
        const self = this;
        this.pipeFrom = src;
        let pipeStat = null;
        if (typeof src.bytesTotal == 'number') {
            self.bytesSize = src.bytesTotal;
        }
        else if (src.fd) {
            pipeStat = fs.fstatSync(src.fd);
            self.bytesSize = pipeStat.size;
        }
        else if (src.path) {
            let p = src.path;
            if (src.cwd && !path.isAbsolute(src.path)) {
                p = path.resolve(src.cwd, src.path);
            }
            pipeStat = fs.statSync(p);
            self.bytesSize = pipeStat.size;
        }
        else {
            self.bytesSize = null;
        }
        this.pipeStat = pipeStat;
        src
            .on('close', function (...argv) {
            self.emit('close', ...argv);
        })
            .on('ready', function (...argv) {
            self.emit('ready', ...argv);
        });
    });
    Object.keys(options)
        .forEach(function (key) {
        if (key.indexOf('on') == 0 && options[key]) {
            wts.on(key.slice(2), options[key]);
        }
    });
    return wts;
}
exports.byLine = byLine;
function createStreamLine(file, fn, options) {
    return stream_pipe_1.createReadStream(file)
        .pipe(byLine(fn, options));
}
exports.createStreamLine = createStreamLine;
function readFileLine(file, fn, options) {
    return wrapStreamToPromise(createStreamLine(file, fn, options));
}
exports.readFileLine = readFileLine;
function wrapStreamToPromise(stream) {
    let resolve, reject;
    let promise = new Promise(function () {
        resolve = arguments[0];
        reject = arguments[1];
    });
    stream
        .on('close', function (...argv) {
        resolve(this);
        //console.log('d.close', ...argv);
    })
        .on('finish', function (...argv) {
        resolve(this);
        //console.log('d.close', ...argv);
    })
        .on('error', function (...argv) {
        reject(...argv);
    });
    promise.stream = stream;
    // @ts-ignore
    promise = promise.bind(stream);
    promise.stream = stream;
    return promise;
}
exports.wrapStreamToPromise = wrapStreamToPromise;
/*
let p = readFileLine('../.gitignore', {

    mapper(data: string)
    {
        return data;
    },

});

p.stream.on('data', function (data)
{
    console.log(data);
});

p.then(function (d: IPipe<ReadStream, NodeJS.WritableStream>)
{
    console.log(this === p.stream, d === this);
});
*/
exports.default = exports;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImxpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILHlCQUEwQjtBQUMxQixpQ0FBa0M7QUFDbEMsNkJBQThCO0FBQzlCLG9DQUFxQztBQUdyQyw2Q0FBc0Q7QUFldEQsU0FBZ0IsTUFBTSxDQUFDLEVBQUcsRUFBRSxVQUFvQixFQUFFO0lBRWpELElBQUksT0FBTyxFQUFFLElBQUksUUFBUSxFQUN6QjtRQUNDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0tBQ2hDO0lBRUQsRUFBRSxHQUFHLEVBQUUsSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDO0lBRTFCLElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxFQUFFLENBQWdCLENBQUM7SUFFcEMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBVSxHQUFHO1FBRTNCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQztRQUVsQixJQUFJLENBQUMsUUFBUSxHQUFHLEdBQUcsQ0FBQztRQUNwQixJQUFJLFFBQVEsR0FBRyxJQUFnQixDQUFDO1FBRWhDLElBQUksT0FBTyxHQUFHLENBQUMsVUFBVSxJQUFJLFFBQVEsRUFDckM7WUFDQyxJQUFJLENBQUMsU0FBUyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUM7U0FDaEM7YUFDSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEVBQ2Y7WUFDQyxRQUFRLEdBQUcsRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7WUFFaEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDO1NBQy9CO2FBQ0ksSUFBSSxHQUFHLENBQUMsSUFBSSxFQUNqQjtZQUNDLElBQUksQ0FBQyxHQUFXLEdBQUcsQ0FBQyxJQUFJLENBQUM7WUFFekIsSUFBSSxHQUFHLENBQUMsR0FBRyxJQUFJLENB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QUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUV4QixPQUFPLE9BQU8sQ0FBQztBQUNoQixDQUFDO0FBakNELGtEQWlDQztBQVlEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0VBbUJFO0FBRUYsa0JBQWUsT0FBa0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlYXRlZCBieSB1c2VyIG9uIDIwMTgvNC8xMS8wMTEuXG4gKi9cblxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKTtcbmltcG9ydCBzcGxpdDIgPSByZXF1aXJlKCdzcGxpdDInKTtcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuaW1wb3J0IHN0cmVhbSA9IHJlcXVpcmUoJ3N0cmVhbScpO1xuXG5pbXBvcnQgeyBjcmVhdGVSZWFkU3RyZWFtLCBJUGlwZSB9IGZyb20gJ3N0cmVhbS1waXBlJztcbmltcG9ydCB7IFJlYWRTdHJlYW0gfSBmcm9tICdzdHJlYW0tcGlwZS9mcyc7XG5cbmV4cG9ydCB0eXBlIElPcHRpb25zID0ge1xuXG5cdG1hcHBlcj8oZGF0YTogc3RyaW5nKSxcblxuXHRvbnBpcGU/KHNyYyksXG5cdG9uY2xvc2U/KC4uLmFyZ3YpLFxuXHRvbmZpbmlzaD8oLi4uYXJndiksXG5cdG9ucmVhZHk/KC4uLmFyZ3YpLFxuXHRvbmRhdGE/KC4uLmFyZ3YpLFxuXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBieUxpbmUoZm4/LCBvcHRpb25zOiBJT3B0aW9ucyA9IHt9KVxue1xuXHRpZiAodHlwZW9mIGZuID09ICdvYmplY3QnKVxuXHR7XG5cdFx0W29wdGlvbnMsIGZuXSA9IFtmbiwgdW5kZWZpbmVkXTtcblx0fVxuXG5cdGZuID0gZm4gfHwgb3B0aW9ucy5tYXBwZXI7XG5cblx0bGV0IHd0cyA9IHNwbGl0MihmbikgYXMgSVN0cmVhbUxpbmU7XG5cblx0d3RzLm9uKCdwaXBlJywgZnVuY3Rpb24gKHNyYylcblx0e1xuXHRcdGNvbnN0IHNlbGYgPSB0aGlzO1xuXG5cdFx0dGhpcy5waXBlRnJvbSA9IHNyYztcblx0XHRsZXQgcGlwZVN0YXQgPSBudWxsIGFzIGZzLlN0YXRzO1xuXG5cdFx0aWYgKHR5cGVvZiBzcmMuYnl0ZXNUb3RhbCA9PSAnbnVtYmVyJylcblx0XHR7XG5cdFx0XHRzZWxmLmJ5dGVzU2l6ZSA9IHNyYy5ieXRlc1RvdGFsO1xuXHRcdH1cblx0XHRlbHNlIGlmIChzcmMuZmQpXG5cdFx0e1xuXHRcdFx0cGlwZVN0YXQgPSBmcy5mc3RhdFN5bmMoc3JjLmZkKTtcblxuXHRcdFx0c2VsZi5ieXRlc1NpemUgPSBwaXBlU3RhdC5zaXplO1xuXHRcdH1cblx0XHRlbHNlIGlmIChzcmMucGF0aClcblx0XHR7XG5cdFx0XHRsZXQgcDogc3RyaW5nID0gc3JjLnBhdGg7XG5cblx0XHRcdGlmIChzcmMuY3dkICYmICFwYXRoLmlzQWJzb2x1dGUoc3JjLnBhdGgpKVxuXHRcdFx0e1xuXHRcdFx0XHRwID0gcGF0aC5yZXNvbHZlKHNyYy5jd2QsIHNyYy5wYXRoKTtcblx0XHRcdH1cblxuXHRcdFx0cGlwZVN0YXQgPSBmcy5zdGF0U3luYyhwKTtcblxuXHRcdFx0c2VsZi5ieXRlc1NpemUgPSBwaXBlU3RhdC5zaXplO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0c2VsZi5ieXRlc1NpemUgPSBudWxsO1xuXHRcdH1cblxuXHRcdHRoaXMucGlwZVN0YXQgPSBwaXBlU3RhdDtcblxuXHRcdHNyY1xuXHRcdFx0Lm9uKCdjbG9zZScsIGZ1bmN0aW9uICguLi5hcmd2KVxuXHRcdFx0e1xuXHRcdFx0XHRzZWxmLmVtaXQoJ2Nsb3NlJywgLi4uYXJndik7XG5cdFx0XHR9KVxuXHRcdFx0Lm9uKCdyZWFkeScsIGZ1bmN0aW9uICguLi5hcmd2KVxuXHRcdFx0e1xuXHRcdFx0XHRzZWxmLmVtaXQoJ3JlYWR5JywgLi4uYXJndik7XG5cdFx0XHR9KVxuXHRcdDtcblx0fSk7XG5cblx0T2JqZWN0LmtleXMob3B0aW9ucylcblx0XHQuZm9yRWFjaChmdW5jdGlvbiAoa2V5KVxuXHRcdHtcblx0XHRcdGlmIChrZXkuaW5kZXhPZignb24nKSA9PSAwICYmIG9wdGlvbnNba2V5XSlcblx0XHRcdHtcblx0XHRcdFx0d3RzLm9uKGtleS5zbGljZSgyKSwgb3B0aW9uc1trZXldKTtcblx0XHRcdH1cblx0XHR9KVxuXHQ7XG5cblx0cmV0dXJuIHd0cztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVN0cmVhbUxpbmUoZmlsZTogc3RyaW5nLCBvcHRpb25zOiBJT3B0aW9ucyk6IElTdHJlYW1MaW5lXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU3RyZWFtTGluZShmaWxlOiBzdHJpbmcsIGZuPzogKGRhdGE6IHN0cmluZykgPT4gYW55LCBvcHRpb25zPzogSU9wdGlvbnMpOiBJU3RyZWFtTGluZVxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVN0cmVhbUxpbmUoZmlsZTogc3RyaW5nLCBmbj8sIG9wdGlvbnM/OiBJT3B0aW9ucylcbntcblx0cmV0dXJuIGNyZWF0ZVJlYWRTdHJlYW0oZmlsZSlcblx0XHQucGlwZShieUxpbmUoZm4sIG9wdGlvbnMpKVxuXHRcdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRGaWxlTGluZShmaWxlOiBzdHJpbmcsIG9wdGlvbnM6IElPcHRpb25zKTogSVByb21pc2VTdHJlYW08SVN0cmVhbUxpbmU+XG5leHBvcnQgZnVuY3Rpb24gcmVhZEZpbGVMaW5lKGZpbGU6IHN0cmluZywgZm4/OiAoZGF0YTogc3RyaW5nKSA9PiBhbnksIG9wdGlvbnM/OiBJT3B0aW9ucyk6IElQcm9taXNlU3RyZWFtPElTdHJlYW1MaW5lPlxuZXhwb3J0IGZ1bmN0aW9uIHJlYWRGaWxlTGluZShmaWxlOiBzdHJpbmcsIGZuPywgb3B0aW9ucz86IElPcHRpb25zKVxue1xuXHRyZXR1cm4gd3JhcFN0cmVhbVRvUHJvbWlzZShjcmVhdGVTdHJlYW1MaW5lKGZpbGUsIGZuLCBvcHRpb25zKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB3cmFwU3RyZWFtVG9Qcm9taXNlPFQgZXh0ZW5kcyBOb2RlSlMuV3JpdGFibGVTdHJlYW0+KHN0cmVhbTogVCk6IElQcm9taXNlU3RyZWFtPFQ+XG57XG5cdGxldCByZXNvbHZlLCByZWplY3Q7XG5cblx0bGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAoKVxuXHR7XG5cdFx0cmVzb2x2ZSA9IGFyZ3VtZW50c1swXTtcblx0XHRyZWplY3QgPSBhcmd1bWVudHNbMV07XG5cdH0pIGFzIElQcm9taXNlU3RyZWFtPFQ+O1xuXG5cdHN0cmVhbVxuXHRcdC5vbignY2xvc2UnLCBmdW5jdGlvbiAoLi4uYXJndilcblx0XHR7XG5cdFx0XHRyZXNvbHZlKHRoaXMpO1xuXHRcdFx0Ly9jb25zb2xlLmxvZygnZC5jbG9zZScsIC4uLmFyZ3YpO1xuXHRcdH0pXG5cdFx0Lm9uKCdmaW5pc2gnLCBmdW5jdGlvbiAoLi4uYXJndilcblx0XHR7XG5cdFx0XHRyZXNvbHZlKHRoaXMpO1xuXHRcdFx0Ly9jb25zb2xlLmxvZygnZC5jbG9zZScsIC4uLmFyZ3YpO1xuXHRcdH0pXG5cdFx0Lm9uKCdlcnJvcicsIGZ1bmN0aW9uICguLi5hcmd2KVxuXHRcdHtcblx0XHRcdHJlamVjdCguLi5hcmd2KTtcblx0XHR9KVxuXHQ7XG5cblx0cHJvbWlzZS5zdHJlYW0gPSBzdHJlYW07XG5cdC8vIEB0cy1pZ25vcmVcblx0cHJvbWlzZSA9IHByb21pc2UuYmluZChzdHJlYW0pO1xuXHRwcm9taXNlLnN0cmVhbSA9IHN0cmVhbTtcblxuXHRyZXR1cm4gcHJvbWlzZTtcbn1cblxuZXhwb3J0IHR5cGUgSVN0cmVhbUxpbmUgPSBJUGlwZTxSZWFkU3RyZWFtLCBOb2RlSlMuV3JpdGFibGVTdHJlYW0+O1xuXG5leHBvcnQgdHlwZSBJU3RyZWFtTGluZVdpdGhWYWx1ZTxUPiA9IElTdHJlYW1MaW5lICYge1xuXHR2YWx1ZT86IFQsXG59O1xuXG5leHBvcnQgdHlwZSBJUHJvbWlzZVN0cmVhbTxUPiA9IFByb21pc2U8VD4gJiB7XG5cdHN0cmVhbTogVCxcbn07XG5cbi8qXG5sZXQgcCA9IHJlYWRGaWxlTGluZSgnLi4vLmdpdGlnbm9yZScsIHtcblxuXHRtYXBwZXIoZGF0YTogc3RyaW5nKVxuXHR7XG5cdFx0cmV0dXJuIGRhdGE7XG5cdH0sXG5cbn0pO1xuXG5wLnN0cmVhbS5vbignZGF0YScsIGZ1bmN0aW9uIChkYXRhKVxue1xuXHRjb25zb2xlLmxvZyhkYXRhKTtcbn0pO1xuXG5wLnRoZW4oZnVuY3Rpb24gKGQ6IElQaXBlPFJlYWRTdHJlYW0sIE5vZGVKUy5Xcml0YWJsZVN0cmVhbT4pXG57XG5cdGNvbnNvbGUubG9nKHRoaXMgPT09IHAuc3RyZWFtLCBkID09PSB0aGlzKTtcbn0pO1xuKi9cblxuZXhwb3J0IGRlZmF1bHQgZXhwb3J0cyBhcyB0eXBlb2YgaW1wb3J0KCcuL2xpbmUnKTtcbiJdfQ==