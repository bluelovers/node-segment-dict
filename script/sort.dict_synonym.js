"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const debug_color2_1 = require("debug-color2");
const fs = require("fs-extra");
const path = require("upath2");
const line_1 = require("../lib/loader/line");
const project_config_1 = require("../project.config");
const util_1 = require("./util");
const array_hyper_unique_1 = require("array-hyper-unique");
let CWD = path.join(project_config_1.default.dict_root, 'segment');
let USE_CJK_MODE = 2;
let CACHE_LIST = {
    skip: [],
};
util_1.globDict(CWD, [
    ...util_1.all_default_load_dict(),
    ...util_1.all_extra_dict(),
], [])
    .tap(function (ls) {
    let a = ls.reduce(function (a, v) {
        let p = path.relative(CWD, v);
        a.push(p);
        //			console.dir(p);
        return a;
    }, []);
    debug_color2_1.console.dir(a);
    //		process.exit();
})
    .mapSeries(async function (file) {
    let _basepath = path.relative(CWD, file);
    debug_color2_1.console.debug(`[START]`, _basepath);
    debug_color2_1.console.time(_basepath);
    let list = await util_1.loadDictFile(file, function (list, cur) {
        cur.file = file;
        let [w, p, f] = cur.data;
        let cjk_id = util_1.getCjkName(w, USE_CJK_MODE);
        cur.cjk_id = cjk_id;
        cur.line_type = util_1.chkLineType(cur.line);
        if (cur.line_type == util_1.EnumLineType.COMMENT) {
            CACHE_LIST.skip.push(cur);
            return false;
        }
        if (f > 15000) {
            //cur.line = [w, toHex(p), 0].join('|');
        }
        return true;
    });
    list = SortList(list);
    let out_list = list.map(v => v.line);
    out_list = array_hyper_unique_1.array_unique(out_list);
    //console.log(list);
    let out_file = file;
    if (0) {
        out_file = path.join(project_config_1.default.temp_root, path.basename(_basepath));
    }
    let out_data = line_1.serialize(out_list) + "\n\n";
    await fs.outputFile(out_file, out_data);
    debug_color2_1.console.timeEnd(_basepath);
})
    .tap(async function () {
    if (CACHE_LIST.skip.length) {
        let list = SortList(CACHE_LIST.skip);
        let out_list = list.map(v => v.line);
        let out_file = path.join(project_config_1.default.temp_root, 'skip2.txt');
        await fs.appendFile(out_file, "\n\n" + line_1.serialize(out_list) + "\n\n");
    }
});
function SortList(ls) {
    // @ts-ignore
    return ls.sort(function (a, b) {
        if (a.line_type == util_1.EnumLineType.COMMENT_TAG
            || b.line_type == util_1.EnumLineType.COMMENT_TAG) {
            return (a.index - b.index);
        }
        else if (a.line_type == util_1.EnumLineType.COMMENT
            || b.line_type == util_1.EnumLineType.COMMENT) {
            return (a.index - b.index);
        }
        let ret = util_1.zhDictCompare(a.cjk_id, b.cjk_id)
            || (a.index - b.index)
            || 0;
        return ret;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydC5kaWN0X3N5bm9ueW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb3J0LmRpY3Rfc3lub255bS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtDQUF1QztBQUN2QywrQkFBK0I7QUFDL0IsK0JBQStCO0FBQy9CLDZDQUErQztBQUMvQyxzREFBOEM7QUFFOUMsaUNBU2dCO0FBRWhCLDJEQUFrRDtBQUdsRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBRXhELElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztBQUVyQixJQUFJLFVBQVUsR0FBRztJQUNoQixJQUFJLEVBQUUsRUFBeUI7Q0FDL0IsQ0FBQztBQUVGLGVBQVEsQ0FBQyxHQUFHLEVBQUU7SUFDYixHQUFHLDRCQUFxQixFQUFFO0lBQzFCLEdBQUcscUJBQWMsRUFBRTtDQUNuQixFQUFFLEVBQUUsQ0FBQztLQUNKLEdBQUcsQ0FBQyxVQUFVLEVBQVk7SUFFMUIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1FBRS9CLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTlCLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFYixvQkFBb0I7UUFFakIsT0FBTyxDQUFDLENBQUM7SUFDVixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFUCxzQkFBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUVqQixtQkFBbUI7QUFDbEIsQ0FBQyxDQUFDO0tBQ0QsU0FBUyxDQUFDLEtBQUssV0FBVyxJQUFJO0lBRTlCLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBRXpDLHNCQUFPLENBQUMs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LElBQUksbUJBQVksQ0FBQyxPQUFPO2VBQ2hDLENBQUMsQ0FBQyxTQUFTLElBQUksbUJBQVksQ0FBQyxPQUFPLEVBRXZDO1lBQ0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzNCO1FBRUQsSUFBSSxHQUFHLEdBQUcsb0JBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUM7ZUFDdkMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUM7ZUFDbkIsQ0FBQyxDQUNKO1FBRUQsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDLENBQUMsQ0FBQTtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBjb25zb2xlIH0gZnJvbSBcImRlYnVnLWNvbG9yMlwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJ1cGF0aDJcIjtcbmltcG9ydCB7IHNlcmlhbGl6ZSB9IGZyb20gJy4uL2xpYi9sb2FkZXIvbGluZSc7XG5pbXBvcnQgUHJvamVjdENvbmZpZyBmcm9tIFwiLi4vcHJvamVjdC5jb25maWdcIjtcblxuaW1wb3J0IHtcblx0YWxsX2RlZmF1bHRfbG9hZF9kaWN0LCBhbGxfZXh0cmFfZGljdCxcblx0Y2hrTGluZVR5cGUsXG5cdEVudW1MaW5lVHlwZSxcblx0Z2V0Q2prTmFtZSxcblx0Z2xvYkRpY3QsXG5cdElMb2FkRGljdEZpbGVSb3cyLFxuXHRsb2FkRGljdEZpbGUsXG5cdHpoRGljdENvbXBhcmUsXG59IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgbmF0dXJhbENvbXBhcmUgPSByZXF1aXJlKCdzdHJpbmctbmF0dXJhbC1jb21wYXJlJyk7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUgfSBmcm9tICdhcnJheS1oeXBlci11bmlxdWUnO1xuaW1wb3J0IHsgdG9IZXggfSBmcm9tICdub3ZlbC1zZWdtZW50L2xpYi91dGlsJztcblxubGV0IENXRCA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLmRpY3Rfcm9vdCwgJ3NlZ21lbnQnKTtcblxubGV0IFVTRV9DSktfTU9ERSA9IDI7XG5cbmxldCBDQUNIRV9MSVNUID0ge1xuXHRza2lwOiBbXSBhcyBJTG9hZERpY3RGaWxlUm93MltdLFxufTtcblxuZ2xvYkRpY3QoQ1dELCBbXG5cdC4uLmFsbF9kZWZhdWx0X2xvYWRfZGljdCgpLFxuXHQuLi5hbGxfZXh0cmFfZGljdCgpLFxuXSwgW10pXG5cdC50YXAoZnVuY3Rpb24gKGxzOiBzdHJpbmdbXSlcblx0e1xuXHRcdGxldCBhID0gbHMucmVkdWNlKGZ1bmN0aW9uIChhLCB2KVxuXHRcdHtcblx0XHRcdGxldCBwID0gcGF0aC5yZWxhdGl2ZShDV0QsIHYpO1xuXG5cdFx0XHRhLnB1c2gocCk7XG5cbi8vXHRcdFx0Y29uc29sZS5kaXIocCk7XG5cblx0XHRcdHJldHVybiBhO1xuXHRcdH0sIFtdKTtcblxuXHRcdGNvbnNvbGUuZGlyKGEpO1xuXG4vL1x0XHRwcm9jZXNzLmV4aXQoKTtcblx0fSlcblx0Lm1hcFNlcmllcyhhc3luYyBmdW5jdGlvbiAoZmlsZSlcblx0e1xuXHRcdGxldCBfYmFzZXBhdGggPSBwYXRoLnJlbGF0aXZlKENXRCwgZmlsZSk7XG5cblx0XHRjb25zb2xlLmRlYnVnKGBbU1RBUlRdYCwgX2Jhc2VwYXRoKTtcblxuXHRcdGNvbnNvbGUudGltZShfYmFzZXBhdGgpO1xuXG5cdFx0bGV0IGxpc3QgPSBhd2FpdCBsb2FkRGljdEZpbGU8SUxvYWREaWN0RmlsZVJvdzI+KGZpbGUsIGZ1bmN0aW9uIChsaXN0LCBjdXIpXG5cdFx0e1xuXHRcdFx0Y3VyLmZpbGUgPSBmaWxlO1xuXG5cdFx0XHRsZXQgW3csIHAsIGZdID0gY3VyLmRhdGE7XG5cblx0XHRcdGxldCBjamtfaWQgPSBnZXRDamtOYW1lKHcsIFVTRV9DSktfTU9ERSk7XG5cblx0XHRcdGN1ci5jamtfaWQgPSBjamtfaWQ7XG5cdFx0XHRjdXIubGluZV90eXBlID0gY2hrTGluZVR5cGUoY3VyLmxpbmUpO1xuXG5cdFx0XHRpZiAoY3VyLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVClcblx0XHRcdHtcblx0XHRcdFx0Q0FDSEVfTElTVC5za2lwLnB1c2goY3VyKTtcblxuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChmID4gMTUwMDApXG5cdFx0XHR7XG5cdFx0XHRcdC8vY3VyLmxpbmUgPSBbdywgdG9IZXgocCksIDBdLmpvaW4oJ3wnKTtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0fSk7XG5cblx0XHRsaXN0ID0gU29ydExpc3QoIGxpc3QpO1xuXG5cdFx0bGV0IG91dF9saXN0ID0gbGlzdC5tYXAodiA9PiB2LmxpbmUpO1xuXG5cdFx0b3V0X2xpc3QgPSBhcnJheV91bmlxdWUob3V0X2xpc3QpO1xuXG5cdFx0Ly9jb25zb2xlLmxvZyhsaXN0KTtcblxuXHRcdGxldCBvdXRfZmlsZSA9IGZpbGU7XG5cblx0XHRpZiAoMClcblx0XHR7XG5cdFx0XHRvdXRfZmlsZSA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLnRlbXBfcm9vdCwgcGF0aC5iYXNlbmFtZShfYmFzZXBhdGgpKTtcblx0XHR9XG5cblx0XHRsZXQgb3V0X2RhdGEgPSBzZXJpYWxpemUob3V0X2xpc3QpICsgXCJcXG5cXG5cIjtcblxuXHRcdGF3YWl0IGZzLm91dHB1dEZpbGUob3V0X2ZpbGUsIG91dF9kYXRhKTtcblxuXHRcdGNvbnNvbGUudGltZUVuZChfYmFzZXBhdGgpO1xuXHR9KVxuXHQudGFwKGFzeW5jIGZ1bmN0aW9uICgpXG5cdHtcblx0XHRpZiAoQ0FDSEVfTElTVC5za2lwLmxlbmd0aClcblx0XHR7XG5cdFx0XHRsZXQgbGlzdCA9IFNvcnRMaXN0KCBDQUNIRV9MSVNULnNraXApO1xuXHRcdFx0bGV0IG91dF9saXN0ID0gbGlzdC5tYXAodiA9PiB2LmxpbmUpO1xuXG5cdFx0XHRsZXQgb3V0X2ZpbGUgPSBwYXRoLmpvaW4oUHJvamVjdENvbmZpZy50ZW1wX3Jvb3QsICdza2lwMi50eHQnKTtcblxuXHRcdFx0YXdhaXQgZnMuYXBwZW5kRmlsZShvdXRfZmlsZSwgXCJcXG5cXG5cIiArIHNlcmlhbGl6ZShvdXRfbGlzdCkgKyBcIlxcblxcblwiKTtcblx0XHR9XG5cdH0pXG47XG5cbmZ1bmN0aW9uIFNvcnRMaXN0PFQgPSBJTG9hZERpY3RGaWxlUm93Mj4obHM6IFRbXSlcbntcblx0Ly8gQHRzLWlnbm9yZVxuXHRyZXR1cm4gbHMuc29ydChmdW5jdGlvbiAoYTogSUxvYWREaWN0RmlsZVJvdzIsIGI6IElMb2FkRGljdEZpbGVSb3cyKVxuXHR7XG5cdFx0aWYgKFxuXHRcdFx0YS5saW5lX3R5cGUgPT0gRW51bUxpbmVUeXBlLkNPTU1FTlRfVEFHXG5cdFx0XHR8fCBiLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVF9UQUdcblx0XHQpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIChhLmluZGV4IC0gYi5pbmRleCk7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKFxuXHRcdFx0YS5saW5lX3R5cGUgPT0gRW51bUxpbmVUeXBlLkNPTU1FTlRcblx0XHRcdHx8IGIubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UXG5cdFx0KVxuXHRcdHtcblx0XHRcdHJldHVybiAoYS5pbmRleCAtIGIuaW5kZXgpO1xuXHRcdH1cblxuXHRcdGxldCByZXQgPSB6aERpY3RDb21wYXJlKGEuY2prX2lkLCBiLmNqa19pZClcblx0XHRcdHx8IChhLmluZGV4IC0gYi5pbmRleClcblx0XHRcdHx8IDBcblx0XHQ7XG5cblx0XHRyZXR1cm4gcmV0O1xuXHR9KVxufVxuIl19