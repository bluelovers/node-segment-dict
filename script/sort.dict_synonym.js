"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const debug_color2_1 = require("debug-color2");
const fs = require("fs-extra");
const path = require("upath2");
const line_1 = require("../lib/loader/line");
const project_config_1 = require("../project.config");
const util_1 = require("./util");
const array_hyper_unique_1 = require("array-hyper-unique");
let CWD = path.join(project_config_1.default.dict_root, 'segment');
let USE_CJK_MODE = 2;
let CACHE_LIST = {
    skip: [],
};
util_1.globDict(CWD, [
    'dict_synonym/*.txt',
    'names/*.txt',
    'lazy/badword.txt',
    'lazy/index.txt',
    'lazy/dict_synonym.txt',
    //'dict*.txt',
    'phrases/*.txt',
    'pangu/*.txt',
    'infrequent/**/*.txt',
    'char.txt',
])
    .tap(function (ls) {
    let a = ls.reduce(function (a, v) {
        let p = path.relative(CWD, v);
        a.push(p);
        return a;
    }, []);
    debug_color2_1.console.debug(a);
    //process.exit();
})
    .mapSeries(async function (file) {
    let _basepath = path.relative(CWD, file);
    debug_color2_1.console.debug(`[START]`, _basepath);
    debug_color2_1.console.time(_basepath);
    let list = await util_1.loadDictFile(file, function (list, cur) {
        cur.file = file;
        let [w, p, f] = cur.data;
        let cjk_id = util_1.getCjkName(w, USE_CJK_MODE);
        cur.cjk_id = cjk_id;
        cur.line_type = util_1.chkLineType(cur.line);
        if (cur.line_type == util_1.EnumLineType.COMMENT) {
            CACHE_LIST.skip.push(cur);
            return false;
        }
        return true;
    });
    list = SortList(list);
    let out_list = list.map(v => v.line);
    out_list = array_hyper_unique_1.array_unique(out_list);
    //console.log(list);
    let out_file = file;
    if (0) {
        out_file = path.join(project_config_1.default.temp_root, path.basename(_basepath));
    }
    let out_data = line_1.serialize(out_list) + "\n\n";
    await fs.outputFile(out_file, out_data);
    debug_color2_1.console.timeEnd(_basepath);
})
    .tap(async function () {
    if (CACHE_LIST.skip.length) {
        let list = SortList(CACHE_LIST.skip);
        let out_list = list.map(v => v.line);
        let out_file = path.join(project_config_1.default.temp_root, 'skip2.txt');
        await fs.appendFile(out_file, "\n\n" + line_1.serialize(out_list) + "\n\n");
    }
});
function SortList(ls) {
    // @ts-ignore
    return ls.sort(function (a, b) {
        if (a.line_type == util_1.EnumLineType.COMMENT_TAG
            || b.line_type == util_1.EnumLineType.COMMENT_TAG) {
            return (a.index - b.index);
        }
        else if (a.line_type == util_1.EnumLineType.COMMENT
            || b.line_type == util_1.EnumLineType.COMMENT) {
            return (a.index - b.index);
        }
        let ret = util_1.zhDictCompare(a.cjk_id, b.cjk_id)
            || (a.index - b.index)
            || 0;
        return ret;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydC5kaWN0X3N5bm9ueW0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb3J0LmRpY3Rfc3lub255bS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtDQUF1QztBQUN2QywrQkFBK0I7QUFDL0IsK0JBQStCO0FBQy9CLDZDQUErQztBQUMvQyxzREFBOEM7QUFFOUMsaUNBUWdCO0FBRWhCLDJEQUFrRDtBQUVsRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsU0FBUyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0FBRXhELElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQztBQUVyQixJQUFJLFVBQVUsR0FBRztJQUNoQixJQUFJLEVBQUUsRUFBeUI7Q0FDL0IsQ0FBQztBQUVGLGVBQVEsQ0FBQyxHQUFHLEVBQUU7SUFDYixvQkFBb0I7SUFDcEIsYUFBYTtJQUNiLGtCQUFrQjtJQUNsQixnQkFBZ0I7SUFDaEIsdUJBQXVCO0lBQ3ZCLGNBQWM7SUFDZCxlQUFlO0lBQ2YsYUFBYTtJQUNiLHFCQUFxQjtJQUNyQixVQUFVO0NBQ1YsQ0FBQztLQUNBLEdBQUcsQ0FBQyxVQUFVLEVBQVk7SUFFMUIsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1FBRS9CLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTlCLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFVixPQUFPLENBQUMsQ0FBQztJQUNWLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUVQLHNCQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRWpCLGlCQUFpQjtBQUNsQixDQUFDLENBQUM7S0FDRCxTQUFTLENBQUMsS0FBSyxXQUFXLElBQUk7SUFFOUIsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFFBQVEs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SUFBSSxtQkFBWSxDQUFDLE9BQU87ZUFDaEMsQ0FBQyxDQUFDLFNBQVMsSUFBSSxtQkFBWSxDQUFDLE9BQU8sRUFFdkM7WUFDQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0I7UUFFRCxJQUFJLEdBQUcsR0FBRyxvQkFBYSxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztlQUN2QyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztlQUNuQixDQUFDLENBQ0o7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNaLENBQUMsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbnNvbGUgfSBmcm9tIFwiZGVidWctY29sb3IyXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInVwYXRoMlwiO1xuaW1wb3J0IHsgc2VyaWFsaXplIH0gZnJvbSAnLi4vbGliL2xvYWRlci9saW5lJztcbmltcG9ydCBQcm9qZWN0Q29uZmlnIGZyb20gXCIuLi9wcm9qZWN0LmNvbmZpZ1wiO1xuXG5pbXBvcnQge1xuXHRjaGtMaW5lVHlwZSxcblx0RW51bUxpbmVUeXBlLFxuXHRnZXRDamtOYW1lLFxuXHRnbG9iRGljdCxcblx0SUxvYWREaWN0RmlsZVJvdzIsXG5cdGxvYWREaWN0RmlsZSxcblx0emhEaWN0Q29tcGFyZSxcbn0gZnJvbSAnLi91dGlsJztcbmltcG9ydCBuYXR1cmFsQ29tcGFyZSA9IHJlcXVpcmUoJ3N0cmluZy1uYXR1cmFsLWNvbXBhcmUnKTtcbmltcG9ydCB7IGFycmF5X3VuaXF1ZSB9IGZyb20gJ2FycmF5LWh5cGVyLXVuaXF1ZSc7XG5cbmxldCBDV0QgPSBwYXRoLmpvaW4oUHJvamVjdENvbmZpZy5kaWN0X3Jvb3QsICdzZWdtZW50Jyk7XG5cbmxldCBVU0VfQ0pLX01PREUgPSAyO1xuXG5sZXQgQ0FDSEVfTElTVCA9IHtcblx0c2tpcDogW10gYXMgSUxvYWREaWN0RmlsZVJvdzJbXSxcbn07XG5cbmdsb2JEaWN0KENXRCwgW1xuXHQnZGljdF9zeW5vbnltLyoudHh0Jyxcblx0J25hbWVzLyoudHh0Jyxcblx0J2xhenkvYmFkd29yZC50eHQnLFxuXHQnbGF6eS9pbmRleC50eHQnLFxuXHQnbGF6eS9kaWN0X3N5bm9ueW0udHh0Jyxcblx0Ly8nZGljdCoudHh0Jyxcblx0J3BocmFzZXMvKi50eHQnLFxuXHQncGFuZ3UvKi50eHQnLFxuXHQnaW5mcmVxdWVudC8qKi8qLnR4dCcsXG5cdCdjaGFyLnR4dCcsXG5dKVxuXHQudGFwKGZ1bmN0aW9uIChsczogc3RyaW5nW10pXG5cdHtcblx0XHRsZXQgYSA9IGxzLnJlZHVjZShmdW5jdGlvbiAoYSwgdilcblx0XHR7XG5cdFx0XHRsZXQgcCA9IHBhdGgucmVsYXRpdmUoQ1dELCB2KTtcblxuXHRcdFx0YS5wdXNoKHApO1xuXG5cdFx0XHRyZXR1cm4gYTtcblx0XHR9LCBbXSk7XG5cblx0XHRjb25zb2xlLmRlYnVnKGEpO1xuXG5cdFx0Ly9wcm9jZXNzLmV4aXQoKTtcblx0fSlcblx0Lm1hcFNlcmllcyhhc3luYyBmdW5jdGlvbiAoZmlsZSlcblx0e1xuXHRcdGxldCBfYmFzZXBhdGggPSBwYXRoLnJlbGF0aXZlKENXRCwgZmlsZSk7XG5cblx0XHRjb25zb2xlLmRlYnVnKGBbU1RBUlRdYCwgX2Jhc2VwYXRoKTtcblxuXHRcdGNvbnNvbGUudGltZShfYmFzZXBhdGgpO1xuXG5cdFx0bGV0IGxpc3QgPSBhd2FpdCBsb2FkRGljdEZpbGU8SUxvYWREaWN0RmlsZVJvdzI+KGZpbGUsIGZ1bmN0aW9uIChsaXN0LCBjdXIpXG5cdFx0e1xuXHRcdFx0Y3VyLmZpbGUgPSBmaWxlO1xuXG5cdFx0XHRsZXQgW3csIHAsIGZdID0gY3VyLmRhdGE7XG5cblx0XHRcdGxldCBjamtfaWQgPSBnZXRDamtOYW1lKHcsIFVTRV9DSktfTU9ERSk7XG5cblx0XHRcdGN1ci5jamtfaWQgPSBjamtfaWQ7XG5cdFx0XHRjdXIubGluZV90eXBlID0gY2hrTGluZVR5cGUoY3VyLmxpbmUpO1xuXG5cdFx0XHRpZiAoY3VyLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVClcblx0XHRcdHtcblx0XHRcdFx0Q0FDSEVfTElTVC5za2lwLnB1c2goY3VyKTtcblxuXHRcdFx0XHRyZXR1cm4gZmFsc2U7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH0pO1xuXG5cdFx0bGlzdCA9IFNvcnRMaXN0KCBsaXN0KTtcblxuXHRcdGxldCBvdXRfbGlzdCA9IGxpc3QubWFwKHYgPT4gdi5saW5lKTtcblxuXHRcdG91dF9saXN0ID0gYXJyYXlfdW5pcXVlKG91dF9saXN0KTtcblxuXHRcdC8vY29uc29sZS5sb2cobGlzdCk7XG5cblx0XHRsZXQgb3V0X2ZpbGUgPSBmaWxlO1xuXG5cdFx0aWYgKDApXG5cdFx0e1xuXHRcdFx0b3V0X2ZpbGUgPSBwYXRoLmpvaW4oUHJvamVjdENvbmZpZy50ZW1wX3Jvb3QsIHBhdGguYmFzZW5hbWUoX2Jhc2VwYXRoKSk7XG5cdFx0fVxuXG5cdFx0bGV0IG91dF9kYXRhID0gc2VyaWFsaXplKG91dF9saXN0KSArIFwiXFxuXFxuXCI7XG5cblx0XHRhd2FpdCBmcy5vdXRwdXRGaWxlKG91dF9maWxlLCBvdXRfZGF0YSk7XG5cblx0XHRjb25zb2xlLnRpbWVFbmQoX2Jhc2VwYXRoKTtcblx0fSlcblx0LnRhcChhc3luYyBmdW5jdGlvbiAoKVxuXHR7XG5cdFx0aWYgKENBQ0hFX0xJU1Quc2tpcC5sZW5ndGgpXG5cdFx0e1xuXHRcdFx0bGV0IGxpc3QgPSBTb3J0TGlzdCggQ0FDSEVfTElTVC5za2lwKTtcblx0XHRcdGxldCBvdXRfbGlzdCA9IGxpc3QubWFwKHYgPT4gdi5saW5lKTtcblxuXHRcdFx0bGV0IG91dF9maWxlID0gcGF0aC5qb2luKFByb2plY3RDb25maWcudGVtcF9yb290LCAnc2tpcDIudHh0Jyk7XG5cblx0XHRcdGF3YWl0IGZzLmFwcGVuZEZpbGUob3V0X2ZpbGUsIFwiXFxuXFxuXCIgKyBzZXJpYWxpemUob3V0X2xpc3QpICsgXCJcXG5cXG5cIik7XG5cdFx0fVxuXHR9KVxuO1xuXG5mdW5jdGlvbiBTb3J0TGlzdDxUID0gSUxvYWREaWN0RmlsZVJvdzI+KGxzOiBUW10pXG57XG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIGxzLnNvcnQoZnVuY3Rpb24gKGE6IElMb2FkRGljdEZpbGVSb3cyLCBiOiBJTG9hZERpY3RGaWxlUm93Milcblx0e1xuXHRcdGlmIChcblx0XHRcdGEubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UX1RBR1xuXHRcdFx0fHwgYi5saW5lX3R5cGUgPT0gRW51bUxpbmVUeXBlLkNPTU1FTlRfVEFHXG5cdFx0KVxuXHRcdHtcblx0XHRcdHJldHVybiAoYS5pbmRleCAtIGIuaW5kZXgpO1xuXHRcdH1cblx0XHRlbHNlIGlmIChcblx0XHRcdGEubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UXG5cdFx0XHR8fCBiLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVFxuXHRcdClcblx0XHR7XG5cdFx0XHRyZXR1cm4gKGEuaW5kZXggLSBiLmluZGV4KTtcblx0XHR9XG5cblx0XHRsZXQgcmV0ID0gemhEaWN0Q29tcGFyZShhLmNqa19pZCwgYi5jamtfaWQpXG5cdFx0XHR8fCAoYS5pbmRleCAtIGIuaW5kZXgpXG5cdFx0XHR8fCAwXG5cdFx0O1xuXG5cdFx0cmV0dXJuIHJldDtcblx0fSlcbn1cbiJdfQ==